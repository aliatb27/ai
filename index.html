<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shiea Ai - المساعد الذكي المختص بنهج أهل البيت (ع)</title>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Import Arabic Font */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');

        :root {
            --sidebar-bg: #202123;
            --main-bg: #343541;
            --user-msg-bg: #343541;
            --ai-msg-bg: #444654;
            --text-primary: #ECECF1;
            --text-secondary: #C5C5D2;
            --input-bg: #40414F;
            --border-color: #2A2B32;
            --accent-color: #10a37f;
            --shiea-accent: #00897B; /* Teal/Green variant */
            --scroll-thumb: #565869;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--main-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 10px;
            transition: transform 0.3s ease;
            position: relative;
            z-index: 100;
        }

        .new-chat-btn {
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-primary);
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background 0.2s;
            margin-bottom: 20px;
        }

        .new-chat-btn:hover {
            background-color: #2A2B32;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .history-item {
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-secondary);
        }

        .history-item:hover {
            background-color: #2A2B32;
        }

        .user-menu {
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
        }

        .user-menu:hover {
            background-color: #2A2B32;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--main-bg);
        }

        .mobile-header {
            display: none;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            justify-content: space-between;
            background-color: var(--main-bg);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 150px;
            scroll-behavior: smooth;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--scroll-thumb);
            border-radius: 4px;
        }

        /* Empty State */
        .empty-state {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        .logo-large {
            width: 80px;
            height: 80px;
            background-color: var(--shiea-accent);
            border-radius: 50%;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 137, 123, 0.3);
            color: white;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 40px;
            width: 100%;
            max-width: 800px;
        }

        .suggestion-card {
            background-color: #3E3F4B;
            padding: 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            border: 1px solid transparent;
        }

        .suggestion-card:hover {
            background-color: var(--input-bg);
            border-color: var(--border-color);
        }

        /* Messages */
        .message {
            padding: 24px;
            display: flex;
            gap: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.ai {
            background-color: var(--ai-msg-bg);
        }

        .message.user {
            background-color: var(--user-msg-bg);
        }

        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .avatar.ai {
            background-color: var(--shiea-accent);
        }

        .avatar.user {
            background-color: #5436DA;
        }

        /* Message Content Formatting for Markdown */
        .message-content {
            line-height: 1.7;
            font-size: 16px;
            max-width: 800px;
            flex: 1;
            overflow-wrap: break-word;
        }

        .message-content p {
            margin-bottom: 1em;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 700;
        }

        .message-content ul, .message-content ol {
            margin-right: 1.5em; /* RTL specific */
            margin-bottom: 1em;
        }

        .message-content li {
            margin-bottom: 0.5em;
        }

        .message-content strong {
            color: #fff;
            font-weight: 700;
        }

        .message-content code {
            background-color: rgba(0,0,0,0.2);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .message-content blockquote {
            border-right: 3px solid var(--shiea-accent); /* RTL */
            margin-right: 0;
            padding-right: 1em;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 1em;
        }
        
        /* Input Area */
        .input-area-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(180deg, rgba(53,53,65,0) 0%, var(--main-bg) 50%);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-container {
            width: 100%;
            max-width: 768px;
            background-color: var(--input-bg);
            border-radius: 15px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border: 1px solid rgba(32,33,35,0.5);
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
            position: relative;
        }

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            max-height: 200px;
            height: 24px;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            outline: none;
            padding: 0;
            margin-left: 10px;
            line-height: 24px;
        }

        .send-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px;
            border-radius: 5px;
            transition: color 0.2s, background 0.2s;
            position: absolute;
            left: 10px;
            bottom: 8px;
        }

        .send-btn:hover {
            background-color: #202123;
            color: var(--shiea-accent);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .footer-text {
            color: #8e8ea0;
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
        }

        /* Loading Dots */
        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100%;
                right: -260px;
            }
            
            .sidebar.active {
                right: 0;
                box-shadow: -5px 0 15px rgba(0,0,0,0.5);
            }

            .mobile-header {
                display: flex;
            }

            .input-area-wrapper {
                padding: 10px;
            }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="new-chat-btn" onclick="resetChat()">
            <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            محادثة جديدة
        </button>

        <div class="history-list" id="historyList">
            <!-- Chat history items will be added here -->
            <div class="history-item" onclick="alert('المحفوظات للعرض فقط في هذا النموذج')">سيرة الإمام علي (ع)</div>
            <div class="history-item">شرح نهج البلاغة</div>
        </div>

        <div class="user-menu">
            <div class="avatar user" style="width: 30px; height: 30px; font-size: 12px;">م</div>
            <span>المستخدم</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <span style="font-weight: bold;">Shiea Ai</span>
            <button onclick="toggleSidebar()" style="background:none; border:none; color:white; cursor:pointer;">
                <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>

        <!-- Chat Area -->
        <div class="chat-container" id="chatContainer">
            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <div class="logo-large">ع</div>
                <h1 style="margin-bottom: 20px;">Shiea Ai</h1>
                <p style="max-width: 500px; margin-bottom: 20px; color: var(--text-secondary);">
                    نظام ذكاء اصطناعي مخصص <strong>حصرياً</strong> للإجابة وفقاً لمنهج أهل البيت (ع).<br>
                    أي أسئلة خارج نطاق الدين، العقيدة الشيعية، أو التاريخ الإسلامي لن يتم الإجابة عليها.
                </p>
                
                <div class="suggestions">
                    <div class="suggestion-card" onclick="setInput('ما هي الأدلة على إمامة علي بن أبي طالب من القرآن؟')">
                        "أدلة إمامة علي (ع) من القرآن"
                        <div style="color: #8e8ea0; margin-top:5px; font-size: 12px;">العقائد</div>
                    </div>
                    <div class="suggestion-card" onclick="setInput('اشرح لي خطبة المتقين من نهج البلاغة')">
                        "شرح خطبة المتقين"
                        <div style="color: #8e8ea0; margin-top:5px; font-size: 12px;">نهج البلاغة</div>
                    </div>
                    <div class="suggestion-card" onclick="setInput('ما هي أعمال ليلة القدر بالتفصيل؟')">
                        "أعمال ليلة القدر"
                        <div style="color: #8e8ea0; margin-top:5px; font-size: 12px;">العبادات والدعاء</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area-wrapper">
            <div class="input-container">
                <textarea id="userInput" rows="1" placeholder="اسأل عن تراث أهل البيت (ع)..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </div>
            <div class="footer-text">
                Shiea Ai مخصص لعلوم أهل البيت فقط. تحقق من المصادر الأصلية دائماً.
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const emptyState = document.getElementById('emptyState');
        const sidebar = document.getElementById('sidebar');
        const sendBtn = document.getElementById('sendBtn');

        // STRICT System Prompt to define the AI Persona and Limitations
        const SYSTEM_PROMPT = `
        تعليمات صارمة للنظام "Shiea Ai":
        أنت مساعد ذكاء اصطناعي متخصص حصرياً في علوم ومعارف الطائفة الشيعية الإمامية الاثني عشرية (مدرسة أهل البيت عليهم السلام).

        قواعدك التي لا يجوز تجاوزها هي:
        1. نطاق العمل: مسموح لك فقط بالإجابة على الأسئلة المتعلقة بـ: العقائد الشيعية، الفقه الشيعي، سيرة أهل البيت، التاريخ الإسلامي من منظور شيعي، تفسير القرآن (تفسير روائي)، والأخلاق الإسلامية.
        
        2. المصادر: استند في إجاباتك حصراً إلى المصادر الشيعية المعتبرة (القرآن الكريم، نهج البلاغة، الصحيفة السجادية، الكتب الأربعة: الكافي، من لا يحضره الفقيه، التهذيب، الاستبصار) وأقوال العلماء الشيعة.

        3. الرفض القاطع: إذا سألك المستخدم أي سؤال خارج هذا الإطار (مثلاً: أسئلة عامة، تكنولوجيا، رياضة، طبخ، سياسة معاصرة غير مرتبطة بالدين، أو أسئلة عن مذاهب أخرى دون سياق مقارن علمي)، يجب عليك رفض الإجابة فوراً وكتابة الجملة التالية فقط دون أي زيادة:
        "أنا مختص بمنهج أهل البيت (ع) فقط."

        4. الأسلوب: تحدث بلغة عربية فصحى، رصينة، ومهذبة تليق بمقام أهل البيت (ع).

        5. الفقه: في المسائل الفقهية، اذكر الآراء المشهورة وانصح السائل بالرجوع لمرجعه الديني لبرائة الذمة.
        
        تذكر: لا تجب على أي موضوع دنيوي بحت أو ترفيهي. هدفك نشر علوم آل محمد فقط.
        `;

        // Store conversation history
        let conversationHistory = [
            { role: "system", content: SYSTEM_PROMPT }
        ];

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            if(textarea.value === '') textarea.style.height = '24px';
        }

        function setInput(text) {
            userInput.value = text;
            autoResize(userInput);
            sendMessage();
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('active');
        }

        function resetChat() {
            chatContainer.innerHTML = '';
            chatContainer.appendChild(emptyState);
            emptyState.style.display = 'flex';
            conversationHistory = [{ role: "system", content: SYSTEM_PROMPT }];
            if(window.innerWidth <= 768) sidebar.classList.remove('active');
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // Disable input while processing
            userInput.disabled = true;
            sendBtn.disabled = true;

            // UI Updates
            emptyState.style.display = 'none';
            appendMessage('user', text);
            userInput.value = '';
            userInput.style.height = '24px';

            // Add user message to history
            conversationHistory.push({ role: "user", content: text });

            // Show loading state
            const loadingId = appendLoading();

            try {
                // Call Free AI Provider (Pollinations.ai)
                // Sending the strict system prompt along with history
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        model: 'openai', // Utilizes general LLM which we are constraining via system prompt
                        seed: Math.floor(Math.random() * 1000)
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const aiText = await response.text();

                // Remove loading and show response
                removeLoading(loadingId);
                appendMessage('ai', aiText);

                // Add AI response to history
                conversationHistory.push({ role: "assistant", content: aiText });

            } catch (error) {
                console.error("Error:", error);
                removeLoading(loadingId);
                appendMessage('ai', 'عذراً، حدث خطأ في الاتصال بالخادم. يرجى المحاولة مرة أخرى.');
            } finally {
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        }

        function appendMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            
            let avatarHTML = '';
            // Render content using Marked.js if it's AI, otherwise plain text (sanitized)
            let contentHTML = '';

            if (sender === 'ai') {
                avatarHTML = `<div class="avatar ai"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>`;
                // Parse Markdown
                contentHTML = marked.parse(text);
            } else {
                avatarHTML = `<div class="avatar user"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></div>`;
                // Simple escape for user text
                const div = document.createElement('div');
                div.textContent = text;
                contentHTML = div.innerHTML.replace(/\n/g, '<br>');
            }

            msgDiv.innerHTML = `
                ${avatarHTML}
                <div class="message-content">${contentHTML}</div>
            `;
            
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ai`;
            msgDiv.id = id;
            msgDiv.innerHTML = `
                <div class="avatar ai"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg></div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }
    </script>
</body>
</html>
